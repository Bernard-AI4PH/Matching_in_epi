---
title: "Matching"
author: "Bernard Asante"
date: "2025-03-13"
output: 
  html_document:
    toc: true
    toc_float: true 
    toc_depth: true
---

# **Loading libraries**

```{r setup, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(adjustedCurves)
library(boot)
library(broom)
library(geepack)
library(here)
library(MatchIt)
library(tableone)
library(sjPlot)
library(survey)
library(episensr) 
library(epitools)
library(gtsummary)
library(cobalt)
library(cowplot)
library(geepack)
library(WeightIt)
```

# **Reading dataset**

## Converting variables to factor 

```{r}
data <- read_csv("mice_all_imp.csv")

data <- data %>% mutate_at(3, factor)
data <- data %>% mutate_at(5:6, factor)
data <- data %>% mutate_at(8:12, factor)
data <- data %>% mutate_at(15:81, factor)
data <- data %>% mutate_at(83:93, factor)
```

## Recoding variables 

I want to find out the causal association between  hypertension and diabetes mellitus using the can_path_student dataset

### Diabetes

Preparing diabetes variable. This will be used as an outcome variable.

From the data dictionary, DIS_DIAB_EVER DICTIONARY has 3 responses:
0 - "Never had diabetes"
1-  "Ever had diabetes"
2 - "Presumed-Never had diabetes"


```{r}
table(data$DIS_DIAB_EVER)
```

Diabetes = 0 (No diabetes ever), Diabetes = 1 (Yes diabetes ever)

```{r}
data <- data %>%
	mutate(diabetes = case_when(
		DIS_DIAB_EVER == 0 ~ 0,
		DIS_DIAB_EVER == 1 ~ 1,
		DIS_DIAB_EVER == 2 ~ 0)) %>%
		mutate(diabetes = as.factor(diabetes))

table(data$DIS_DIAB_EVER, data$diabetes)

data$DIS_DIAB_EVER <- NULL  # Removing DIS_DIAB_EVER from the dataset because it has already being recoded
```

###  Hypertension 

From the data dictionary, DIS_HBP_EVER DICTIONARY has 3 responses:
0 - "Never had high blood pressure"
1-  "Ever had  high blood pressure"
2 - "Presumed-Never had  high blood pressure"


```{r}
table(data$DIS_HBP_EVER)
```

unemployed = 0 (Not unemployed), unemployed = 1 (Unemployed)

```{r}
data <- data %>%
	mutate(hypertension = case_when(
		DIS_HBP_EVER == 0 ~ 0,
		DIS_HBP_EVER == 1 ~ 1,
		DIS_HBP_EVER == 2 ~ 0)) %>%
		mutate(hypertension = as.factor(hypertension))

table(data$DIS_HBP_EVER, data$hypertension)

data$DIS_HBP_EVER <- NULL  # Removing DIS_DIAB_EVER from the dataset because it has already being recoded
```


# **Measure of Association(CRUDE)**

## Contingency table 

```{r}
contingency_table <- table(data$hypertension, data$diabetes)

contingency_table
```
Just doing chi square analysis to see the association between the two variables. 

## Chi square analysis 

```{r}
chi_square <- chisq.test(contingency_table)
chi_square
```
There is a significant association between hypertension and diabetes with a p value less than 0.001.

I want to find the odds having diabetes if one has hypertension( hypertension== 1)


##  Epi tools method

```{r}
hpt <- c("No", "Yes")
outc <- c("Case", "Control")
dat <- matrix(c(1408, 29857, 1706, 8216),2,2,byrow=TRUE)
dimnames(dat) <- list("Hypertension" = hpt, "Outcome" = outc)
oddsratio(dat, rev="c")
```
From the output, it can be seen that those with hypertension has 4.4 times higher odds of diabetes compared to those without hypertension(p value <0.001, CI 4.09 to 4.74).

## Logistic Regression(sigmoid function) 

```{r}
log_model <- data %>% 
  glm(diabetes ~ hypertension, family = "binomial", data = .)

tab_model(log_model)
```
It can be seen that hypertension[1] has 4.4 higher odds of diabetes with pvalue of less than 0.001 (cI = 4.09 to 4.74)


From this point, I want to match participants in the treatment to see how it will affect the association between hypertension and diabetes. 


# **Matching methods**

## Defining closeness

I want to select list of variables that are associated with hypertension and match these covariates before calculating the association.

Literature review has not been done but I know physical inactivity, bmi, health status, income, alcohol etc contributes to hypertention 

```{r}
covariates <- data %>% 
  select( ALC_EVER,DIS_MI_EVER,DIS_STROKE_EVER,HS_GEN_HEALTH,SMK_CIG_EVER,DIS_CARDIO_HD_EVER,PA_TOTAL_SHORT,WRK_UNABLE, WRK_STUDENT, PSE_ADULT_WRK_DURATION, WH_CONTRACEPTIVES_EVER, SDC_INCOME, SDC_EDU_LEVEL_AGE, SDC_GENDER, SDC_AGE_CALC )
baselines <- colnames(covariates)
baselines
```

```{r}
tab_baseline <- CreateTableOne(vars = baselines,
                       data = data, 
                       strata = "hypertension", 
                       test = FALSE, #mute P-value calculation;
                       smd = TRUE,
                       addOverall = TRUE)

kableone(tab_baseline, smd = TRUE, showAllLevels = FALSE )
```


After visual inspection, I can see major difference between cases and control in dis_mi_ever 1, dis_stroke ever 0, hs_gen_health 4, smoke_cig_ever 1, dis_cardio_hd_ever 0, wh_contraceptives_ever 1, sdc_gender = 2.





